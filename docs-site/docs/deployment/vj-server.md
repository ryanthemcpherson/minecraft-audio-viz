# VJ Server Deployment

The VJ Server is the central hub that receives audio frames from DJs, runs the Lua pattern engine, and broadcasts visualization data to Minecraft and browser clients.

## Requirements

- Python 3.11+
- Can run on Windows, macOS, or Linux

## Installation

```bash
cd vj_server
pip install -e .
```

## Running

### Basic Usage

```bash
# Start on default port 9000
audioviz-vj

# Custom DJ port
audioviz-vj --port 9000

# Connect to Minecraft server
audioviz-vj --minecraft-host mc.local

# Dev mode - skip authentication
audioviz-vj --no-auth
```

### Default Ports

| Port | Purpose |
|------|---------|
| 9000 | DJ WebSocket connections |
| 8766 | Browser WebSocket broadcast |
| 8080 | Admin panel HTTP |
| 8765 | Minecraft WebSocket (outbound) |

## Configuration

### Server Config

Server settings can be configured via environment variables:

| Variable | Default | Description |
|----------|---------|-------------|
| `MINECRAFT_HOST` | `localhost` | Minecraft server hostname |
| `MINECRAFT_PORT` | `8765` | Minecraft plugin WebSocket port |
| `VJ_SERVER_PORT` | `9000` | DJ connection port |
| `PREVIEW_PORT` | `8766` | Browser preview WebSocket port |
| `HTTP_PORT` | `8080` | Admin panel HTTP port |
| `DJ_AUTH_FILE` | `configs/dj_auth.json` | DJ credentials file path |

### DJ Authentication

For production use, the VJ server enforces authentication by default. DJ credentials are stored in `configs/dj_auth.json`.

Connect codes use the format `WORD-XXXX` (e.g., `BEAT-7K3M`) and are generated by the VJ server. They expire after 30 minutes and are single-use.

Use `--no-auth` for development only.

## Multi-DJ Management

The VJ server supports multiple simultaneous DJ connections:

- Only one DJ is "active" at a time (their audio drives the visualization)
- VJ admin can switch active DJ, manage the queue, and trigger effects
- DJs are tracked with connection health, frame rate, and latency metrics

## Pattern Engine

The VJ server runs a Lua-based pattern engine that transforms audio data into entity positions. Patterns are auto-discovered from `patterns/*.lua` and support hot-reloading.

28 built-in patterns are included, covering spectrum analyzers, geometric shapes, cosmic effects, organic simulations, and more.

## Message Flow

When the VJ server receives a `dj_audio_frame`, it:

1. Updates the DJ's connection state (latency, frame count, bands)
2. If this DJ is active, constructs an `AudioState` from the frame
3. Runs the current visualization pattern's `calculate()` function
4. Sends `batch_update` to Minecraft with entity positions (normalized 0-1)
5. Broadcasts the same data to browser preview clients

## Performance Profiles

The server supports different performance configurations:

| Profile | Description |
|---------|-------------|
| `default` | Standard settings with MMCSS and lock-free buffer |
| `low_latency` | Smaller buffer, optimized for minimal delay |
| `high_compatibility` | Larger buffer, no MMCSS, maximum compatibility |
