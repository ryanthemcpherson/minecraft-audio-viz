name: Update Minecraft Server Jar

on:
  schedule:
    - cron: '17 9 * * *'
  workflow_dispatch:
    inputs:
      provider:
        description: 'Jar source provider'
        required: true
        default: 'paper'
        type: choice
        options:
          - paper
          - url
      minecraft_version:
        description: 'Minecraft version (for Paper, optional if auto-detected)'
        required: false
        type: string
      jar_url:
        description: 'Direct jar URL (required when provider=url)'
        required: false
        type: string
      jar_sha256:
        description: 'Optional SHA256 for provider=url'
        required: false
        type: string

concurrency:
  group: update-minecraft-jar
  cancel-in-progress: false

jobs:
  update-jar:
    name: Update server jar on dev host
    runs-on: [self-hosted, dev-server]
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v6

      - name: Resolve inputs
        id: resolve
        shell: bash
        env:
          INPUT_PROVIDER: ${{ github.event.inputs.provider }}
          INPUT_MC_VERSION: ${{ github.event.inputs.minecraft_version }}
          INPUT_JAR_URL: ${{ github.event.inputs.jar_url }}
          INPUT_JAR_SHA256: ${{ github.event.inputs.jar_sha256 }}
        run: |
          PROVIDER="${INPUT_PROVIDER}"
          if [ -z "$PROVIDER" ]; then
            PROVIDER="paper"
          fi
          echo "provider=$PROVIDER" >> "$GITHUB_OUTPUT"
          echo "mc_version=$INPUT_MC_VERSION" >> "$GITHUB_OUTPUT"
          echo "jar_url=$INPUT_JAR_URL" >> "$GITHUB_OUTPUT"
          echo "jar_sha256=$INPUT_JAR_SHA256" >> "$GITHUB_OUTPUT"

      - name: Update jar
        shell: bash
        env:
          RESOLVED_PROVIDER: ${{ steps.resolve.outputs.provider }}
          RESOLVED_MC_VERSION: ${{ steps.resolve.outputs.mc_version }}
          RESOLVED_JAR_URL: ${{ steps.resolve.outputs.jar_url }}
          RESOLVED_JAR_SHA256: ${{ steps.resolve.outputs.jar_sha256 }}
        run: |
          set -euo pipefail
          args=(--provider "$RESOLVED_PROVIDER")

          if [ -n "$RESOLVED_MC_VERSION" ]; then
            args+=(--mc-version "$RESOLVED_MC_VERSION")
          fi

          if [ "$RESOLVED_PROVIDER" = "url" ]; then
            if [ -z "$RESOLVED_JAR_URL" ]; then
              echo "jar_url is required when provider=url" >&2
              exit 1
            fi
            args+=(--jar-url "$RESOLVED_JAR_URL")

            if [ -n "$RESOLVED_JAR_SHA256" ]; then
              args+=(--sha256 "$RESOLVED_JAR_SHA256")
            fi
          fi

          bash ./scripts/update-minecraft-jar.sh "${args[@]}"

      - name: Post-update status
        shell: bash
        env:
          RESOLVED_PROVIDER: ${{ steps.resolve.outputs.provider }}
          RESOLVED_MC_VERSION: ${{ steps.resolve.outputs.mc_version }}
        run: |
          echo "### Server Jar Update" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Provider: \`${RESOLVED_PROVIDER}\`" >> "$GITHUB_STEP_SUMMARY"
          if [ -n "$RESOLVED_MC_VERSION" ]; then
            echo "- Minecraft version input: \`${RESOLVED_MC_VERSION}\`" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "- Service: \`minecraft.service\`" >> "$GITHUB_STEP_SUMMARY"
