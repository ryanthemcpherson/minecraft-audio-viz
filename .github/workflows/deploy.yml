name: Deploy to Dev Server

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests before deploy'
        required: false
        default: 'false'
        type: boolean

# Only one deploy at a time
concurrency:
  group: deploy-dev
  cancel-in-progress: false

env:
  DEPLOY_PATH: /home/ryan/minecraft-audio-viz
  PLUGINS_DIR: /home/ryan/minecraft-server/plugins
  JAVA_VERSION: '21'
  RCON_PORT: '25575'

jobs:
  # ---------------------------------------------------------------------------
  # Build the Minecraft plugin JAR (on GitHub-hosted runner for caching)
  # ---------------------------------------------------------------------------
  build-plugin:
    name: Build Plugin JAR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        working-directory: minecraft_plugin
        run: mvn clean package -DskipTests

      - name: Upload plugin JAR
        uses: actions/upload-artifact@v6
        with:
          name: audioviz-plugin
          path: minecraft_plugin/target/audioviz-plugin-*.jar

  # ---------------------------------------------------------------------------
  # Run Python tests (unless skipped) â€” on GitHub-hosted runner
  # ---------------------------------------------------------------------------
  test-python:
    name: Python Tests
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest audio_processor/tests/ -v --tb=short

  # ---------------------------------------------------------------------------
  # Deploy on the dev server itself (self-hosted runner)
  # ---------------------------------------------------------------------------
  deploy:
    name: Deploy to Dev Server
    needs: [build-plugin, test-python]
    if: always() && needs.build-plugin.result == 'success' && (needs.test-python.result == 'success' || needs.test-python.result == 'skipped')
    runs-on: [self-hosted, dev-server]
    environment: dev-server
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v6
        with:
          clean: true

      - name: Download plugin JAR
        uses: actions/download-artifact@v7
        with:
          name: audioviz-plugin
          path: ./plugin-jar/

      # --- Sync code to deploy path ---
      - name: Sync repository to deploy path
        run: |
          echo "=== Syncing code to ${{ env.DEPLOY_PATH }} ==="
          mkdir -p "${{ env.DEPLOY_PATH }}"

          rsync -a --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude 'target' \
            --exclude 'dist' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude 'dj_client/src-tauri/target' \
            --exclude 'minecraft_plugin/target' \
            "$GITHUB_WORKSPACE/" "${{ env.DEPLOY_PATH }}/"

      # --- Copy plugin JAR ---
      - name: Copy plugin JAR to plugins directory
        run: |
          echo "=== Copying plugin JAR ==="
          mkdir -p "${{ env.PLUGINS_DIR }}"
          rm -f "${{ env.PLUGINS_DIR }}"/audioviz-plugin-*.jar
          cp -v ./plugin-jar/audioviz-plugin-*.jar "${{ env.PLUGINS_DIR }}/"

      # --- Install Python dependencies ---
      - name: Install Python dependencies
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "=== Installing/updating Python dependencies ==="
          python3 -m pip install -e ".[dev]" --quiet 2>&1 | tail -5

      # --- Run tests on server ---
      - name: Run tests on server
        working-directory: ${{ env.DEPLOY_PATH }}
        run: |
          echo "=== Running Python tests on server ==="
          python3 -m pytest audio_processor/tests/ -v --tb=short

      # --- Restart Minecraft server ---
      - name: Restart Minecraft server
        run: |
          echo "=== Restarting Minecraft server ==="
          sudo systemctl restart minecraft.service

          echo "=== Waiting for Minecraft to start ==="
          sleep 10

          echo "=== Health check ==="
          if systemctl is-active --quiet minecraft.service; then
            echo "SUCCESS: minecraft.service is running"
          else
            echo "ERROR: minecraft.service failed to start"
            sudo journalctl -u minecraft.service --no-pager -n 30
            exit 1
          fi

      # --- Verify plugin loaded ---
      - name: Verify AudioViz plugin is active
        env:
          MCAV_RCON_PASSWORD: ${{ secrets.MCAV_RCON_PASSWORD }}
        run: |
          if [ -z "${MCAV_RCON_PASSWORD:-}" ]; then
            echo "RCON secret not set; skipping plugin status check."
            exit 0
          fi

          echo "=== Verifying AudioViz plugin via RCON ==="
          for i in $(seq 1 12); do
            PLUGINS_OUTPUT="$(mcrcon -H 127.0.0.1 -P "${{ env.RCON_PORT }}" -p "${MCAV_RCON_PASSWORD}" "plugins" 2>&1 || true)"
            echo "Attempt $i: $PLUGINS_OUTPUT"
            if echo "$PLUGINS_OUTPUT" | grep -qi "AudioViz"; then
              echo "SUCCESS: AudioViz plugin is loaded"
              exit 0
            fi
            sleep 5
          done

          echo "ERROR: AudioViz plugin not found in plugin list after retries"
          sudo journalctl -u minecraft.service --no-pager -n 80
          exit 1

      # --- Summary ---
      - name: Deploy summary
        if: always()
        run: |
          echo "### Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner:** $(hostname) (self-hosted)" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy Path:** ${{ env.DEPLOY_PATH }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
